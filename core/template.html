<!doctype html>
<!---
to create {weak,strong,mighty}.html from template.html run:
declare -A aa=( [weak]=7 [strong]=15 [mighty]=64 )
for x in "${!aa[@]}"; do sed -e "s/MAXLENGTH/${aa[$x]}/" template.html > $x.html; done
--->
<!--based on
https://www.jqueryscript.net/tags.php?/Password%20Generator"
jQuery Password Generator
-->
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=128">
<title>Password Generator</title>

<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!--
.container {
  margin-top:16px;
  max-width:256px;
}
-->

<style>body {
  font-family: "Arial";
}
button {
    margin: 0 auto;
    display: block;
}
.container {
  margin-top:16px;
  max-width:300px;
  justify-content: center;
}

.p1 {font-family: "Times New Roman", Times, serif;}
.p2 {font-family: Arial, Helvetica, sans-serif;}
.p3 {font-family: "Courier New", monospace;}
  div {
    margin-bottom: 10px;
  }
  label {
    display: inline-block;
    width: 150px;
    text-align: left;
  }
</style>

</head>

<p class="p3">

<body>
<div class="container">
  <h4 style="text-align:center;">Length in 1-MAXLENGTH range </h4>

<div class="form-group" style="display:flex;"></div>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<script>
    // MAXLENGTH = 15
    // setCookie(), getCookie()
    // see: https://www.w3schools.com/js/js_cookies.asp

    function setCookie(name, value, days) {
      const date = new Date();
      date.setTime(date.getTime() + (days*24*3600*1000));
      var append = `${name}=${value};expires=${date.toGMTString()};path=/`;
      document.cookie = append;
    }

    function getCookie(name, default_value='default_cookie') {
      let nameEQ = name + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      var value = default_value;
      for(var i=0;i < ca.length; i++) {
        let c = ca[i];
        if (c.indexOf(nameEQ) > -1) {
          value = c.substring(c.indexOf(nameEQ) + nameEQ.length)
          break;
        }
      }
      return value;
    }
</script>

<p class="p3">
  <div class="container" style="display:flex;">
    <!--- <label>Hint:</label>
    <input type="text" placeholder="enter input" title="Enter input here">
    <input id="hint" class="form-control" style="background-color:lightblue;" value='' />
    -->
    <input id="hint" class="form-control" placeholder="hint to generate password" style="background-color:lightblue;" />
  </div>
  <div class="container" style="display:flex;"> <label>Salt:</label>
    <input class="form-control" id="salt" />
    <script>
      document.getElementById("salt").value = getCookie('salt', 'salt')
    </script>
  </div>
  <div class="container" style="display:flex;"> <label>Pepper:</label>
    <input class="form-control" id="pepper" />
    <script>
      document.getElementById("pepper").value = getCookie('pepper', '!')
   </script>    
  </div>
  <div class="container" style="display:flex;"> <label>Length:</label>
    <input class="form-control" type="number" id="length" min="1" max="MAXLENGTH"/>
    <script>
      var n = getCookie('length', MAXLENGTH)
      // console.log(`DEBUG: length from cookie: n= ${n}, MAXLENGTH= ${MAXLENGTH}`)
      n = Math.min(Math.max(1, n), MAXLENGTH + 1)
      document.getElementById("length").value = n
      if (n < 1 || n > MAXLENGTH) {
        alert("Length must be between 1 and MAXLENGTH!");
      } // else {
      //  alert("Valid number!");
      // }
      // console.log(`DEBUG: length after min/max: n= ${n}, MAXLENGTH= ${MAXLENGTH}`)
   </script>
  </div>

<!---
<div class="container" style="display:flex;"> <label>Burnin:</label>
  <input id="burnin" class="form-control" value=0> </div>
---->
<div class="container" style="display:flex;">
  <button id="generate" class="btn btn-default"
        style="background-color:lightgreen;font-weight:900;width:100%;text-align:center">
        Generate and copy to clipboard
  </button>
</div>

<hr style="background-color:red;height:1px;margin-left:16% !important; margin-right:2% !important;">
<div class="container" style="display:flex;"id="passwords"></div>
<hr style="background-color:red;height:1px;margin-left:16% !important; margin-right:2% !important;">

<script>

const MP31 = 2**31 - 1;
const assert = console.assert;

print = console.log

/* permute chars in string using Durstenfeld shuffle algorithm */
function shuffle_string(string, gint=rig(MP31, seed)) {
  let z = string.split(''), i, j;
  for (i = z.length - 1; i > 0; i--) {
      j = gint.next().value % i;
      [z[i], z[j]] = [z[j], z[i]]
  }
  return z.join('')
}

function hash_string(s) {
  assert(typeof(s) === 'string', `string expected, got ${s}`)
  const p = 2**5 - 1, m = MP31 // 2**31 - 1; // Mersenne primes: 2^(2, 3, 5, 7, 13, 17, 19, 31, 67, 127, 257)
  var value = MP31 // 2**31 - 1;
  var pp = 1;
  for (var j=0; j < s.length; j++) {
      value = (value + s.charCodeAt(j) * pp) % m;
      pp = (pp * p) % m;
  }
  return value;
}

/*
create small array of random integers
Donald Knuth MMIX: m = 2**64; a=6364136223846793005; c = 1442695040888963407
*/
// random integer generator
// generates integers in [0, max) interval
function* rig(max, hint) {
  let m = MP31, a=2147483629, c=2147483587;
  assert(typeof(max) === 'number' && (0 < max) && (max <= m),
    `rig: max (=${max}) must be number and has to be smaller than 2**31 - 1`)
  assert(typeof(hint) === 'string', `hint must be string, got ${typeof(hint)}`)
  var seed = hint == '' ? Date.now() : hash_string(hint)
  while (true) {
    seed = (a * seed + c) % m;
    yield Math.abs(seed % max)
  }
}

function get_random_string(n, charset='', gint=rig(MP31, '')) { // seed=undefined) {
  /*
  n       : length of string to generate
  charset : alphabet to use; NOTE: all unicode chars will be used if charset == ''
  gint    : random integer generator
  */
  const MAX_CODE_POINT = 1114111 + 1;
  assert(charset.length < MAX_CODE_POINT, `too long charset, ${charset.length}`)
  /*
  see:
  https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/fromCharCode
  */
  let z = '';
  for (let i=0; i < n; i++) {
    let k = gint.next().value
    z += (charset !== '') ? charset[k % charset.length] : String.fromCodePoint(k % MAX_CODE_POINT)
  }
  return z
}

function getPass(args) {
  /*
  args.pepper        : pepper for generated password
  args.hint        : hint to generate password
  args.burn        : number of 'burn' steps in rng
  args.plength     : length of password
  args.digits      : should digits be used?
  args.letters     : should letters be used?
  args.punctuation : should punctuation be used?
  */

  const CHARS = {}
  CHARS.digits = '0123456789'
  CHARS.lower = 'abcdefghijklmnopqrstuvwxyz'
  CHARS.upper = CHARS.lower.toUpperCase()
  CHARS.punctuation = '!"#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~'

  var charset = ''
  if (!args.unicode) {
    if (args.digits) charset += CHARS.digits
    if (args.letters) charset += CHARS.lower + CHARS.upper
    if (args.punctuation) charset += CHARS.punctuation
    if (charset.length == 0) charset = CHARS.digits + CHARS.lower + CHARS.upper
  }

  var passwd;
  if (args.hint === '') { // generate and return random string from charset
      passwd = get_random_string(args.plength, charset)
  } else {
      /*
      add to pepper one lower, one upper character and one digit
      to satisfy requirements of many sites
      one or more special characters can be provided in args.pepper (default='!')
      */
      let hint = args.hint + args.salt + args.pepper + args.plength
      let gint = rig(MP31, hint)
      for (let k=0; k < args.burnin; k++) { gint.next().value }
      let lower = get_random_string(1, CHARS.lower,  gint)
      let upper = get_random_string(1, CHARS.upper,  gint)
      let digit = get_random_string(1, CHARS.digits, gint)
      const pepper = args.pepper + lower + upper + digit
      let n = args.plength - pepper.length
      if (args.debug) {
        print(`DEBUG: getPass: args.hint= ${args.hint}`)
        print(`DEBUG: getPass: args.salt= ${args.salt}`)
        print(`DEBUG: getPass: args.pepper= ${args.pepper}`)
        print(`DEBUG: getPass: pepper= ${pepper}`)
        print(`DEBUG: getPass: args.plength= ${args.plength}`)
        print(`DEBUG: getPass: args.burnin= ${args.burnin}`)
        print(`DEBUG: getPass: n= ${n}`)
        print(`DEBUG: getPass: hint= ${hint}`)
      }
      assert(n > 0, `pepper too long: args.plength= ${args.plength}, args.pepper= ${args.pepper}`)
      passwd = get_random_string(n, charset, gint)
      passwd = pepper + passwd // augment password with pepper e.g. '!'
      if (!args.no_shuffle) {
        passwd = shuffle_string(passwd, gint)
      }
  }
  copy_to_clipboard(passwd)
  if (args.verbose) {
    print(`password >>> ${passwd} <<< (copied to clipboard)`)
  }
  return passwd
}

function copy_to_clipboard(x) {
    if (typeof window === "undefined") {
      const CLIP = require('clipboardy');
      CLIP.writeSync(x)
    } else {
      /*
      from: https://www.30secondsofcode.org/js/s/copy-to-clipboard
      see also: https://github.com/w3c/clipboard-apis/blob/master/explainer.adoc#writing-to-the-clipboard
      */
      const copyToClipboard = str => {
        const el = document.createElement('textarea');
        el.value = str;
        el.setAttribute('readonly', '');
        el.style.position = 'absolute';
        el.style.left = '-9999px';
        document.body.appendChild(el);
        const selected =
          document.getSelection().rangeCount > 0
            ? document.getSelection().getRangeAt(0)
            : false;
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        if (selected) {
          document.getSelection().removeAllRanges();
          document.getSelection().addRange(selected);
        }
      };
      copyToClipboard(x);
    }
}

// var g = randint_gen(charset.length, )
$("#reload").click(function() {location.reload()})
$("#generate").click(function() {
  let args = {};
  // if (typeof window !== 'undefined') {
  // get args from window
  args.hint = $('#hint').val()
  args.salt = $('#salt').val()
  args.pepper = $('#pepper').val()
  args.plength = Math.min(Math.max(1, $('#length').val()), MAXLENGTH)
  args.burnin = 0 // $('#burnin').val()
  args.digits = false
  args.unicode = false
  args.digits = false
  args.lower = false
  args.upper = false
  args.punctuation = false
  args.no_shuffle = false
  args.debug = true
  args.verbose = true
  let passwd = getPass(args);
  $('#passwords').prepend(passwd + '<br>');
  setCookie('salt', $('#salt').val(), 7)
  setCookie('pepper', $('#pepper').val(), 7)
  setCookie('length', $('#length').val(), 7)
});

</script>

</body>
</html>
